
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–æ—Ä–º—ã —Ä–∞—Å—Ö–æ–¥–∞ –ø–µ—Å—Ç–∏—Ü–∏–¥–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 0 auto 25px;
            max-width: 600px;
        }

        .mode-button {
            flex: 1;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            padding: 12px 16px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .mode-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.35);
        }

        .mode-button:focus-visible {
            outline: 3px solid rgba(102, 126, 234, 0.35);
            outline-offset: 2px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 1.1em;
        }

        .pesticide-warning {
            background: rgba(255, 99, 71, 0.12);
            border: 1px solid rgba(255, 99, 71, 0.4);
            color: #c0392b;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .area-input-group {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .calculate-btn, .buy-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .calculate-btn:hover, .buy-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .calculate-btn:active, .buy-btn:active {
            transform: translateY(-1px);
        }

        .buy-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin-top: 15px;
        }

        .buy-btn:hover {
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            border-left: 5px solid #667eea;
            display: none;
        }

        .results.show {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-weight: 600;
            color: #333;
        }

        .result-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .info-text, .features-text {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
            border-left: 4px solid #667eea;
        }

        .warning-text {
            color: #dc3545;
            font-weight: 600;
            text-align: center;
            margin-top: 20px;
            font-size: 0.95em;
        }

        .contact-text {
            color: #666;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .analog-link {
            display: inline-block;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            background: none;
            border: none;
            font: inherit;
            padding: 0;
            transition: color 0.2s ease;
        }

        .analog-link:hover,
        .analog-link:focus {
            color: #4953c4;
            outline: none;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 16px;
            padding: 25px 30px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            transform: translateY(20px);
            opacity: 0;
        }

        .modal-overlay.show .modal-content {
            animation: slideUp 0.3s ease forwards;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 24px;
            line-height: 1;
            color: #888;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: #333;
            outline: none;
        }

        .modal-body {
            font-size: 0.95em;
            color: #444;
            line-height: 1.5;
        }

        .modal-price {
            margin-top: 15px;
            font-weight: 600;
            color: #333;
        }

        .modal-buy-btn {
            margin-top: 20px;
            display: inline-block;
            padding: 12px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #fff;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .modal-buy-btn:hover,
        .modal-buy-btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(32, 201, 151, 0.4);
            outline: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–æ—Ä–º—ã —Ä–∞—Å—Ö–æ–¥–∞ –ø–µ—Å—Ç–∏—Ü–∏–¥–æ–≤
        </h1>

        <div class="mode-toggle" role="group" aria-label="–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞">
            <button type="button" class="mode-button active" data-mode="product">–ü–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç—É</button>
            <button type="button" class="mode-button" data-mode="disease">–ü–æ –±–æ–ª–µ–∑–Ω–∏</button>
            <button type="button" class="mode-button" data-mode="pest">–ü–æ –≤—Ä–µ–¥–∏—Ç–µ–ª—é</button>
        </div>

        <form id="calculatorForm">
            <div class="form-group" id="modeSubjectGroup" style="display: none;">
                <label for="modeSubject" id="modeSubjectLabel">1. –ü–∞—Ç–æ–≥–µ–Ω:</label>
                <select id="modeSubject" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ç–æ–≥–µ–Ω</option>
                </select>
            </div>

            <div class="form-group">
                <label for="category" id="categoryLabel">1. –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–µ—Å—Ç–∏—Ü–∏–¥–æ–≤:</label>
                <select id="category" required disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                </select>
            </div>

            <div class="form-group">
                <label for="pesticide" id="pesticideLabel">2. –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:</label>
                <div id="pesticideWarning" class="pesticide-warning" style="display: none;">
                    –í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã –∏–∑ –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ FRAC/IRAC –≥—Ä—É–ø–ø—ã –ø–æ–¥—Ä—è–¥ –±–æ–ª–µ–µ 1‚Äì2 –æ–±—Ä–∞–±–æ—Ç–æ–∫.
                </div>
                <select id="pesticide" required disabled>
                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                </select>
            </div>

            <div class="form-group">
                <label for="culture" id="cultureLabel">3. –ö—É–ª—å—Ç—É—Ä–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–π –æ–±—ä–µ–∫—Ç:</label>
                <select id="culture" required disabled>
                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç</option>
                </select>
            </div>

            <div class="form-group">
                <label for="harmfulObject" id="harmfulObjectLabel">4. –í—Ä–µ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç:</label>
                <select id="harmfulObject" required disabled>
                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É–ª—å—Ç—É—Ä—É</option>
                </select>
            </div>

            <div class="form-group">
                <label for="intensity" id="intensityLabel">5. –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:</label>
                <select id="intensity" required disabled>
                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç</option>
                </select>
            </div>

            <div class="form-group">
                <label for="area" id="areaLabel">6. –ü–ª–æ—â–∞–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:</label>
                <div class="area-input-group">
                    <input type="number" id="area" step="0.01" min="0.01" required>
                    <select id="areaUnit">
                        <option value="ha">–≥–∞</option>
                        <option value="m2">–º¬≤</option>
                        <option value="sotka">—Å–æ—Ç–∫–∏</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="tankVolume" id="tankVolumeLabel">7. –û–±—ä–µ–º –±–∞–∫–∞ –æ–ø—Ä—ã—Å–∫–∏–≤–∞—Ç–µ–ª—è (–ª):</label>
                <input type="number" id="tankVolume" step="0.1" min="0.1" required>
            </div>

            <button type="submit" class="calculate-btn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        </form>

        <div id="results" class="results">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞:</h3>
            <div class="result-item">
                <span class="result-label">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:</span>
                <span id="totalPesticide" class="result-value">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Ç–≤–æ—Ä–∞:</span>
                <span id="totalSolution" class="result-value">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–∞–≤–æ–∫ –±–∞–∫–∞:</span>
                <span id="tankRefills" class="result-value">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">–ü—Ä–µ–ø–∞—Ä–∞—Ç–∞ –Ω–∞ –æ–¥–Ω—É –∑–∞–ø—Ä–∞–≤–∫—É:</span>
                <span id="pesticidePerTank" class="result-value">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:</span>
                <span id="treatmentCost" class="result-value">-</span>
            </div>
            <div class="features-text" id="applicationFeatures">
                –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞
            </div>
            <div class="info-text" id="additionalInfo">
                –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞
            </div>
            <div class="info-text" id="analogsInfo">
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–Ω–∞–ª–æ–≥–∞—Ö –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞
            </div>
            <a id="buyButton" href="#" target="_blank" class="buy-btn" style="display: none;">
                üõí –ö—É–ø–∏—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç
            </a>
            
            <div class="warning-text">
                ‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ! –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏
            </div>
            <div class="contact-text">
                –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ —Ä–∞–±–æ—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –º–æ–∂–Ω–æ –ø—Ä–∏—Å—ã–ª–∞—Ç—å –Ω–∞ agroshop-24@yandex.ru —Å –ø–æ–º–µ—Ç–∫–æ–π "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–æ—Ä–º—ã —Ä–∞—Å—Ö–æ–¥–∞ –ø–µ—Å—Ç–∏—Ü–∏–¥–æ–≤"
            </div>
        </div>
    </div>

    <div id="analogModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="analogModalTitle">
            <button type="button" class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">&times;</button>
            <h3 id="analogModalTitle"></h3>
            <div id="analogModalBody" class="modal-body"></div>
            <p id="analogModalPrice" class="modal-price"></p>
            <a id="analogModalBuyButton" class="modal-buy-btn" href="#" target="_blank" rel="noopener">–ö—É–ø–∏—Ç—å</a>
        </div>
    </div>

    <script>
        // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Å—Ç–∏—Ü–∏–¥–æ–≤ –∏–∑ PDF —Ñ–∞–π–ª–∞
        // –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV
        let pesticideData = {}; // –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function populateCategories() {
            const categories = new Set();
            for (const product in pesticideData) {
                categories.add(pesticideData[product].category);
            }

            categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });

            categorySelect.disabled = false;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ data.json
        async function loadJSON() {
            try {
                const response = await fetch('data.json'); // —Ñ–∞–π–ª —Ä—è–¥–æ–º —Å HTML
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å data.json');
                pesticideData = await response.json();
                populateCategories();
                console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ JSON:', pesticideData);
            } catch (error) {
                console.error(error);
            }
        }

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const categoryGroup = document.getElementById('category').closest('.form-group');
        const categorySelect = document.getElementById('category');
        const pesticideSelect = document.getElementById('pesticide');
        const cultureSelect = document.getElementById('culture');
        const harmfulObjectSelect = document.getElementById('harmfulObject');
        const intensitySelect = document.getElementById('intensity');
        const areaInput = document.getElementById('area');
        const areaUnitSelect = document.getElementById('areaUnit');
        const tankVolumeInput = document.getElementById('tankVolume');
        const resultsDiv = document.getElementById('results');
        const form = document.getElementById('calculatorForm');
        const buyButton = document.getElementById('buyButton');
        const treatmentCostElement = document.getElementById('treatmentCost');
        const analogsInfo = document.getElementById('analogsInfo');
        const analogModal = document.getElementById('analogModal');
        const analogModalTitle = document.getElementById('analogModalTitle');
        const analogModalBody = document.getElementById('analogModalBody');
        const analogModalPrice = document.getElementById('analogModalPrice');
        const analogModalBuyButton = document.getElementById('analogModalBuyButton');
        const analogModalCloseButton = analogModal.querySelector('.modal-close');
        const modeButtons = document.querySelectorAll('.mode-button');
        const modeSubjectGroup = document.getElementById('modeSubjectGroup');
        const modeSubjectSelect = document.getElementById('modeSubject');
        const modeSubjectLabel = document.getElementById('modeSubjectLabel');
        const categoryLabel = document.getElementById('categoryLabel');
        const pesticideLabel = document.getElementById('pesticideLabel');
        const cultureLabel = document.getElementById('cultureLabel');
        const harmfulObjectLabel = document.getElementById('harmfulObjectLabel');
        const harmfulObjectGroup = harmfulObjectSelect.closest('.form-group');
        const intensityLabel = document.getElementById('intensityLabel');
        const areaLabel = document.getElementById('areaLabel');
        const tankVolumeLabel = document.getElementById('tankVolumeLabel');
        const pesticideWarning = document.getElementById('pesticideWarning');

        const modes = {
            product: 'product',
            disease: 'disease',
            pest: 'pest'
        };

        let currentMode = modes.product;

        analogModalBuyButton.style.display = 'none';

        analogModalCloseButton.addEventListener('click', closeAnalogModal);
        analogModal.addEventListener('click', (event) => {
            if (event.target === analogModal) {
                closeAnalogModal();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && analogModal.classList.contains('show')) {
                closeAnalogModal();
            }
        });

        analogsInfo.addEventListener('click', async (event) => {
            const trigger = event.target.closest('.analog-link');
            if (!trigger) return;

            event.preventDefault();
            const productName = decodeURIComponent(trigger.dataset.product);
            await showAnalogModal(productName);
        });

        async function fetchProductPrice(productUrl) {
            if (!productUrl) return null;
            try {
                const response = await fetch(`${productUrl}.json`);
                if (!response.ok) throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è ${productUrl}`);
                const data = await response.json();
                const price = Number(data?.product?.price_min);
                return Number.isFinite(price) ? price : null;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–µ–Ω—ã –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:', error);
                return null;
            }
        }

        function updatePesticideWarning() {
            const shouldShowWarning = currentMode === modes.disease || currentMode === modes.pest;
            pesticideWarning.style.display = shouldShowWarning ? 'block' : 'none';
        }

        // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
        const intensityOptions = {
            'minimum': { label: '–ú–∏–Ω–∏–º—É–º', value: 'minimum' },
            'medium': { label: '–°—Ä–µ–¥–Ω–µ–µ', value: 'medium' },
            'maximum': { label: '–ú–∞–∫—Å–∏–º—É–º', value: 'maximum' }
        };

        function resetSelect(selectElement, placeholder, disabled = true) {
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            selectElement.disabled = disabled;
        }

        function updateLabelsForMode() {
            const isProductMode = currentMode === modes.product;
            const subjectLabel = currentMode === modes.pest ? '1. –í—Ä–µ–¥–∏—Ç–µ–ª—å:' : '1. –ü–∞—Ç–æ–≥–µ–Ω:';

            modeSubjectGroup.style.display = isProductMode ? 'none' : 'block';
            categoryGroup.style.display = isProductMode ? 'block' : 'none';
            harmfulObjectGroup.style.display = isProductMode ? 'block' : 'none';

            modeSubjectLabel.textContent = subjectLabel;
            if (isProductMode) {
                categoryLabel.textContent = '1. –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–µ—Å—Ç–∏—Ü–∏–¥–æ–≤:';
                pesticideLabel.textContent = '2. –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:';
                cultureLabel.textContent = '3. –ö—É–ª—å—Ç—É—Ä–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–π –æ–±—ä–µ–∫—Ç:';
                harmfulObjectLabel.textContent = '4. –í—Ä–µ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç:';
                intensityLabel.textContent = '5. –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:';
                areaLabel.textContent = '6. –ü–ª–æ—â–∞–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:';
                tankVolumeLabel.textContent = '7. –û–±—ä–µ–º –±–∞–∫–∞ –æ–ø—Ä—ã—Å–∫–∏–≤–∞—Ç–µ–ª—è (–ª):';
            } else {
                pesticideLabel.textContent = '2. –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:';
                cultureLabel.textContent = '3. –ö—É–ª—å—Ç—É—Ä–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–π –æ–±—ä–µ–∫—Ç:';
                intensityLabel.textContent = '4. –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:';
                areaLabel.textContent = '5. –ü–ª–æ—â–∞–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:';
                tankVolumeLabel.textContent = '6. –û–±—ä–µ–º –±–∞–∫–∞ –æ–ø—Ä—ã—Å–∫–∏–≤–∞—Ç–µ–ª—è (–ª):';
            }
        }

        function updateModeSubjectOptions() {
            if (currentMode === modes.product) return;

            const placeholder = currentMode === modes.disease
                ? '–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ç–æ–≥–µ–Ω'
                : '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–¥–∏—Ç–µ–ª—è';

            resetSelect(modeSubjectSelect, placeholder, false);

            const option = document.createElement('option');
            option.value = currentMode === modes.disease ? '–ú—É—á–Ω–∏—Å—Ç–∞—è —Ä–æ—Å–∞' : '–ü—å—è–≤–∏—Ü–∞';
            option.textContent = option.value;
            modeSubjectSelect.appendChild(option);
        }

        function resetWorkflowSelects() {
            const firstStepPlaceholder = currentMode === modes.product
                ? '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'
                : '';

            resetSelect(categorySelect, firstStepPlaceholder || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞', currentMode !== modes.product);

            const pesticidePlaceholder = currentMode === modes.product
                ? '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'
                : `–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ ${currentMode === modes.disease ? '–ø–∞—Ç–æ–≥–µ–Ω' : '–≤—Ä–µ–¥–∏—Ç–µ–ª—è'}`;

            resetSelect(pesticideSelect, pesticidePlaceholder);
            resetSelect(cultureSelect, '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç');
            resetSelect(harmfulObjectSelect, '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É–ª—å—Ç—É—Ä—É');
            resetSelect(intensitySelect, currentMode === modes.product
                ? '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç'
                : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É–ª—å—Ç—É—Ä—É');
            resultsDiv.classList.remove('show');
        }

        function setMode(mode) {
            currentMode = mode;
            modeButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.mode === mode);
            });

            updateLabelsForMode();
            resetWorkflowSelects();
            updatePesticideWarning();

            if (currentMode === modes.product) {
                modeSubjectSelect.value = '';
                modeSubjectSelect.disabled = true;
                populateCategories();
            } else {
                updateModeSubjectOptions();
            }
        }

        function setCategoryFromProduct(productData) {
            const categoryValue = productData?.category || '';
            const label = categoryValue || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
            categorySelect.innerHTML = `<option value="${escapeHtml(label)}">${escapeHtml(label)}</option>`;
            categorySelect.value = categoryValue;
            categorySelect.disabled = currentMode !== modes.product;
        }

        function productSupportsTarget(productData, targetText) {
            if (!productData || !targetText) return false;

            const categoryName = (productData.category || '').toLowerCase();
            if (currentMode === modes.disease && !categoryName.includes('—Ñ—É–Ω–≥–∏—Ü')) return false;
            if (currentMode === modes.pest && !categoryName.includes('–∏–Ω—Å–µ–∫—Ç–∏—Ü')) return false;

            const cultures = productData.cultures || {};

            return Object.values(cultures).some(harmfulObjects =>
                Object.keys(harmfulObjects).some(harmful => harmful.toLowerCase().includes(targetText))
            );
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        modeButtons.forEach(button => {
            button.addEventListener('click', () => setMode(button.dataset.mode));
        });

        modeSubjectSelect.addEventListener('change', updatePesticideOptions);
        categorySelect.addEventListener('change', updatePesticideOptions);
        pesticideSelect.addEventListener('change', updateCultureOptions);
        cultureSelect.addEventListener('change', updateHarmfulObjectOptions);
        harmfulObjectSelect.addEventListener('change', updateIntensityOptions);
        form.addEventListener('submit', calculateResults);

        function updatePesticideOptions() {
            const targetText = modeSubjectSelect.value.trim().toLowerCase();
            resetSelect(pesticideSelect, '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç');
            resetSelect(cultureSelect, '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç');
            resetSelect(harmfulObjectSelect, '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É–ª—å—Ç—É—Ä—É');
            resetSelect(intensitySelect, '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç');

            let matchingProducts = [];

            if (currentMode === modes.product) {
                const category = categorySelect.value;
                if (!category) {
                    pesticideSelect.disabled = true;
                    cultureSelect.disabled = true;
                    harmfulObjectSelect.disabled = true;
                    intensitySelect.disabled = true;
                    return;
                }

                matchingProducts = Object.keys(pesticideData)
                    .filter(key => pesticideData[key].category === category)
                    .map(name => ({ name, data: pesticideData[name] }));
            } else {
                if (!targetText) {
                    pesticideSelect.disabled = true;
                    cultureSelect.disabled = true;
                    harmfulObjectSelect.disabled = true;
                    intensitySelect.disabled = true;
                    return;
                }

                matchingProducts = Object.entries(pesticideData)
                    .filter(([, data]) => productSupportsTarget(data, targetText))
                    .map(([name, data]) => ({ name, data }));
            }

            if (matchingProducts.length === 0) {
                pesticideSelect.disabled = true;
                cultureSelect.disabled = true;
                harmfulObjectSelect.disabled = true;
                intensitySelect.disabled = true;
                return;
            }

            pesticideSelect.disabled = false;

            if (currentMode === modes.product) {
                matchingProducts
                    .sort((a, b) => a.name.localeCompare(b.name, 'ru'))
                    .forEach(({ name }) => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = buildPesticideOptionLabel(name, pesticideData[name]);
                        pesticideSelect.appendChild(option);
                    });
            } else {
                const moALabel = currentMode === modes.disease ? 'FRAC' : 'IRAC';
                const groupedProducts = new Map();

                matchingProducts.forEach(product => {
                    const normalizedMoA = normalizeMoAValue(product.data.moA) || '‚Äî';
                    const displayMoA = formatMoAValues(product.data.moA) || '‚Äî';

                    if (!groupedProducts.has(normalizedMoA)) {
                        groupedProducts.set(normalizedMoA, { label: displayMoA, items: [] });
                    }

                    groupedProducts.get(normalizedMoA).items.push(product);
                });

                Array.from(groupedProducts.values())
                    .sort((a, b) => a.label.localeCompare(b.label, 'ru'))
                    .forEach(group => {
                        const readableLabel = group.label && group.label !== '‚Äî' ? group.label : '–±–µ–∑ –∫–æ–¥–∞';
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `${moALabel} ${readableLabel}`.trim();

                        group.items
                            .sort((a, b) => a.name.localeCompare(b.name, 'ru'))
                            .forEach(({ name }) => {
                                const option = document.createElement('option');
                                const moAText = group.label && group.label !== '‚Äî' ? group.label : '‚Äî';
                                option.value = name;
                                option.textContent = buildPesticideOptionLabel(name, pesticideData[name], `${moALabel} ${moAText} ‚Äî`);
                                optgroup.appendChild(option);
                            });

                        pesticideSelect.appendChild(optgroup);
                    });
            }
        }

        function updateCultureOptions() {
            const pesticide = pesticideSelect.value;
            resetSelect(cultureSelect, '–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–ª—å—Ç—É—Ä—É/–æ–±—ä–µ–∫—Ç');
            resetSelect(harmfulObjectSelect, '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É–ª—å—Ç—É—Ä—É');
            resetSelect(intensitySelect, '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç');

            if (!(pesticide && pesticideData[pesticide])) {
                cultureSelect.disabled = true;
                harmfulObjectSelect.disabled = true;
                intensitySelect.disabled = true;
                return;
            }

            const productData = pesticideData[pesticide];
            if (currentMode !== modes.product) {
                setCategoryFromProduct(productData);
            }

            const targetText = modeSubjectSelect.value.trim().toLowerCase();
            const cultures = Object.keys(productData.cultures || {});

            const matchingCultures = currentMode === modes.product
                ? cultures
                : cultures.filter(culture =>
                    Object.keys(productData.cultures[culture]).some(harmful => harmful.toLowerCase().includes(targetText))
                );

            if (matchingCultures.length === 0) {
                cultureSelect.disabled = true;
                harmfulObjectSelect.disabled = true;
                intensitySelect.disabled = true;
                return;
            }

            cultureSelect.disabled = false;

            matchingCultures
                .sort((a, b) => a.localeCompare(b, 'ru'))
                .forEach(culture => {
                    const option = document.createElement('option');
                    option.value = culture;
                    option.textContent = culture;
                    cultureSelect.appendChild(option);
                });
        }

        function updateHarmfulObjectOptions() {
            const pesticide = pesticideSelect.value;
            const culture = cultureSelect.value;
            const harmfulPlaceholder = currentMode === modes.product ? '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç' : '';
            const intensityPlaceholder = currentMode === modes.product
                ? '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç'
                : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É–ª—å—Ç—É—Ä—É';

            resetSelect(harmfulObjectSelect, harmfulPlaceholder);
            resetSelect(intensitySelect, intensityPlaceholder);

            if (!(pesticide && culture && pesticideData[pesticide]?.cultures[culture])) {
                harmfulObjectSelect.disabled = true;
                intensitySelect.disabled = true;
                return;
            }

            const targetText = modeSubjectSelect.value.trim().toLowerCase();
            const harmfulObjects = Object.keys(pesticideData[pesticide].cultures[culture]);

            const matchingHarmfulObjects = currentMode === modes.product
                ? harmfulObjects
                : harmfulObjects.filter(harmful => harmful.toLowerCase().includes(targetText));

            if (matchingHarmfulObjects.length === 0) {
                harmfulObjectSelect.disabled = true;
                intensitySelect.disabled = true;
                return;
            }

            if (currentMode === modes.product) {
                harmfulObjectSelect.disabled = false;

                matchingHarmfulObjects
                    .sort((a, b) => a.localeCompare(b, 'ru'))
                    .forEach(harmfulObject => {
                        const option = document.createElement('option');
                        option.value = harmfulObject;
                        option.textContent = harmfulObject;
                        harmfulObjectSelect.appendChild(option);
                    });
            } else {
                const selectedHarmfulObject = matchingHarmfulObjects.sort((a, b) => a.localeCompare(b, 'ru'))[0];
                harmfulObjectSelect.innerHTML = `<option value="${escapeHtml(selectedHarmfulObject)}">${escapeHtml(selectedHarmfulObject)}</option>`;
                harmfulObjectSelect.value = selectedHarmfulObject;
                harmfulObjectSelect.disabled = true;
                updateIntensityOptions();
            }
        }

        function updateIntensityOptions() {
            const harmfulObject = harmfulObjectSelect.value;
            intensitySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏</option>';

            if (harmfulObject) {
                intensitySelect.disabled = false;

                for (const intensity in intensityOptions) {
                    const option = document.createElement('option');
                    option.value = intensity;
                    option.textContent = intensityOptions[intensity].label;
                    intensitySelect.appendChild(option);
                }
            } else {
                intensitySelect.disabled = true;
            }
        }

        function convertAreaToHa(area, unit) {
            switch (unit) {
                case 'ha': return area;
                case 'm2': return area / 10000;
                case 'sotka': return area / 100;
                default: return area;
            }
        }

        function formatArea(area, unit) {
            switch (unit) {
                case 'ha': return `${area} –≥–∞`;
                case 'm2': return `${area} –º¬≤`;
                case 'sotka': return `${area} —Å–æ—Ç–æ–∫`;
                default: return `${area} ${unit}`;
            }
        }

        function getYearWord(years) {
            if (years % 10 === 1 && years % 100 !== 11) {
                return '–≥–æ–¥';
            } else if ([2, 3, 4].includes(years % 10) && ![12, 13, 14].includes(years % 100)) {
                return '–≥–æ–¥–∞';
            } else {
                return '–ª–µ—Ç';
            }
        }

        function formatMoAValues(value) {
            if (value === null || value === undefined) return '‚Äî';
            if (Array.isArray(value)) return value.join(', ');
            return value.toString();
        }

        function getPesticideDetails(productData) {
            if (!productData) return '';

            const parts = [];

            if (productData.form) {
                parts.push(productData.form);
            }

            const activeIngredientInfo = productData.activeIngredientInfo || '';
            const activeIngredient = productData.activeIngredient || '';
            const activeIngredientConcentration = productData.activeIngredientConcentration;

            if (activeIngredientInfo) {
                parts.push(activeIngredientInfo);
            } else if (activeIngredient && activeIngredientConcentration) {
                parts.push(`${activeIngredient} ${activeIngredientConcentration}`);
            } else if (activeIngredient) {
                parts.push(activeIngredient);
            }

            return parts.join(', ');
        }

        function buildPesticideOptionLabel(name, productData, prefixText = '') {
            const details = getPesticideDetails(productData);
            const baseLabel = details ? `${name} (${details})` : name;
            return prefixText ? `${prefixText} ${baseLabel}` : baseLabel;
        }

        function getMoALabelByCategory(categoryName) {
            const normalized = (categoryName || '').toLowerCase();

            if (normalized.includes('—Ñ—É–Ω–≥–∏—Ü')) return 'FRAC - –∫–æ–¥';
            if (normalized.includes('–∏–Ω—Å–µ–∫—Ç–∏—Ü')) return 'IRAC - –∫–æ–¥';
            if (normalized.includes('–≥–µ—Ä–±–∏—Ü')) return 'HRAC - –∫–æ–¥';

            return 'MoA - –∫–æ–¥';
        }

        function normalizeMoAValue(value) {
            if (value === null || value === undefined) return '';

            if (Array.isArray(value)) {
                return value
                    .map(item => item?.toString().trim().toLowerCase())
                    .filter(Boolean)
                    .sort()
                    .join('|');
            }

            return value.toString().trim().toLowerCase();
        }

        function calculateIntensityValues(objectData, intensity) {
            let rate, liquidRate;

            switch (intensity) {
                case 'minimum':
                    rate = objectData.minRate;
                    liquidRate = objectData.maxLiquid; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∂–∏–¥–∫–æ—Å—Ç—å –¥–ª—è –º–∏–Ω–∏–º—É–º–∞
                    break;
                case 'maximum':
                    rate = objectData.maxRate;
                    liquidRate = objectData.minLiquid; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∂–∏–¥–∫–æ—Å—Ç—å –¥–ª—è –º–∞–∫—Å–∏–º—É–º–∞
                    break;
                case 'medium':
                default:
                    rate = objectData.avgRate;
                    liquidRate = objectData.avgLiquid;
                    break;
            }

            return { rate, liquidRate };
        }

        function normalizeFormValue(formValue) {
            if (!formValue) return '';

            const normalized = formValue
                .toString()
                .trim()
                .toLowerCase()
                .replace(/\s+/g, ' ');

            const formSynonyms = {
                '–∫—Å (–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç —Å—É—Å–ø–µ–Ω–∑–∏–∏)': '–∫—Å/—Å–∫ (–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç —Å—É—Å–ø–µ–Ω–∑–∏–∏)',
                '—Å–∫ (—Å—É—Å–ø–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç)': '–∫—Å/—Å–∫ (–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç —Å—É—Å–ø–µ–Ω–∑–∏–∏)'
            };

            return formSynonyms[normalized] || normalized;
        }

        function formsAreEquivalent(formA, formB) {
            return normalizeFormValue(formA) === normalizeFormValue(formB);
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return text
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function openAnalogModal() {
            analogModal.classList.add('show');
            analogModal.setAttribute('aria-hidden', 'false');
        }

        function closeAnalogModal() {
            analogModal.classList.remove('show');
            analogModal.setAttribute('aria-hidden', 'true');
            analogModal.removeAttribute('data-product');
        }

        async function showAnalogModal(productName) {
            const product = pesticideData[productName];
            if (!product) return;

            const isKg = (product.unit || '').toLowerCase().includes('–∫–≥');
            const concentrationUnit = isKg ? '–≥/–∫–≥' : '–≥/–ª';
            const packagingUnit = isKg ? '–∫–≥' : '–ª';
            const rawPackaging = product.packaging;
            const packagingValue = Number(rawPackaging);
            const hasNumericPackaging = Number.isFinite(packagingValue) && packagingValue > 0;
            const packagingText = hasNumericPackaging
                ? `${packagingValue} ${packagingUnit}`
                : (rawPackaging ? rawPackaging.toString() : '‚Äî');

            const ingredients = product.activeIngredients || {};
            const ingredientsText = Object.entries(ingredients)
                .map(([name, concentration]) => `${name} ${concentration} ${concentrationUnit}`)
                .join(', ') || '‚Äî';

            const chemicalClass = product.chemicalClass || product.chemical–°lass || '‚Äî';
            const moALabel = getMoALabelByCategory(product.category || '');
            const moAFormatted = formatMoAValues(product.moA);
            const manufacturer = product.manufactory || '‚Äî';

            analogModal.dataset.product = productName;
            analogModalTitle.textContent = productName;
            analogModalBody.innerHTML = `
                <strong>–§–æ—Ä–º–∞:</strong> ${escapeHtml(product.form || '‚Äî')}<br>
                <strong>–î–µ–π—Å—Ç–≤—É—é—â–∏–µ –≤–µ—â–µ—Å—Ç–≤–∞:</strong> ${escapeHtml(ingredientsText)}<br>
                <strong>–•–∏–º–∏—á–µ—Å–∫–∏–π –∫–ª–∞—Å—Å:</strong> ${escapeHtml(chemicalClass)}<br>
                <strong>${moALabel}:</strong> ${escapeHtml(moAFormatted)}<br>
                <strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</strong> ${escapeHtml(manufacturer)}<br>
                <strong>–£–ø–∞–∫–æ–≤–∫–∞:</strong> ${escapeHtml(packagingText)}
            `;

            if (product.url) {
                analogModalBuyButton.href = product.url;
                analogModalBuyButton.style.display = 'inline-block';
            } else {
                analogModalBuyButton.removeAttribute('href');
                analogModalBuyButton.style.display = 'none';
            }

            analogModalPrice.textContent = '–¶–µ–Ω–∞: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶';
            openAnalogModal();

            if (!product.url) {
                analogModalPrice.textContent = '–¶–µ–Ω–∞: –Ω/–¥';
                return;
            }

            const pricePerPackage = await fetchProductPrice(product.url);

            if (analogModal.dataset.product !== productName) {
                return; // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–∂–µ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
            }

            if (pricePerPackage !== null) {
                const packageLabel = packagingText !== '‚Äî' ? ` –∑–∞ —É–ø–∞–∫–æ–≤–∫—É ${packagingText}` : '';
                analogModalPrice.textContent = `–¶–µ–Ω–∞: ${pricePerPackage.toFixed(2)} ‚ÇΩ${packageLabel}`;
            } else {
                analogModalPrice.textContent = '–¶–µ–Ω–∞: –Ω/–¥';
            }
        }

        async function calculateResults(e) {
            e.preventDefault();
            
            const category = categorySelect.value;
            const pesticide = pesticideSelect.value;
            const culture = cultureSelect.value;
            const harmfulObject = harmfulObjectSelect.value;
            const intensity = intensitySelect.value;
            const area = parseFloat(areaInput.value);
            const areaUnit = areaUnitSelect.value;
            const tankVolume = parseFloat(tankVolumeInput.value);
            
            if (!category || !pesticide || !culture || !harmfulObject || !intensity || !area || !tankVolume) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            const pesticideInfo = pesticideData[pesticide];
            const objectData = pesticideInfo.cultures[culture][harmfulObject];
            const { rate, liquidRate } = calculateIntensityValues(objectData, intensity);
            const areaInHa = convertAreaToHa(area, areaUnit);
            
            // –†–∞—Å—á–µ—Ç –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –∏ —Ä–∞—Å—Ç–≤–æ—Ä–∞
            const totalPesticide = areaInHa * rate;
            const totalSolution = areaInHa * liquidRate;

            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
            const isKg = objectData.unit.includes('–∫–≥');
            
            // –†–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–∞–≤–æ–∫ –∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –Ω–∞ –∑–∞–ø—Ä–∞–≤–∫—É
            const tankRefills = Math.ceil(totalSolution / tankVolume);
            const pesticidePerTank = totalPesticide / tankRefills;

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –µ–¥–∏–Ω–∏—Ü–∞–º–∏
            function formatPesticideAmount(amount, isKg) {
                if (amount < 1) {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–ª/–º–≥
                    const smallAmount = amount * 1000;
                    const unit = isKg ? '–º–≥' : '–º–ª';
                    return `${smallAmount.toFixed(1)} ${unit}`;
                } else {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–≥/–ª
                    const unit = isKg ? '–∫–≥' : '–ª';
                    return `${amount.toFixed(3)} ${unit}`;
                }
            }

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            document.getElementById('totalPesticide').textContent =
                formatPesticideAmount(totalPesticide, isKg);
            document.getElementById('totalSolution').textContent =
                `${totalSolution.toFixed(1)} –ª`;
            document.getElementById('tankRefills').textContent = 
                `${tankRefills} ${tankRefills === 1 ? '–∑–∞–ø—Ä–∞–≤–∫–∞' : '–∑–∞–ø—Ä–∞–≤–æ–∫'}`;
            document.getElementById('pesticidePerTank').textContent =
                formatPesticideAmount(pesticidePerTank, isKg);

            // –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
            treatmentCostElement.textContent = '‚Äî';
            const packagingVolume = Number(pesticideInfo.packaging);
            const pricePerPackage = await fetchProductPrice(pesticideInfo.url);

            if (Number.isFinite(packagingVolume) && packagingVolume > 0 && pricePerPackage !== null) {
                const pricePerUnit = pricePerPackage / packagingVolume;
                const costPerTank = pesticidePerTank * pricePerUnit;
                const totalCost = costPerTank * tankRefills;
                treatmentCostElement.textContent = `${totalCost.toFixed(2)} ‚ÇΩ`;
            } else {
                treatmentCostElement.textContent = '–Ω/–¥';
            }

            // –†–∞—Å—á–µ—Ç –Ω–æ—Ä–º—ã —Ä–∞—Å—Ö–æ–¥–∞ –Ω–∞ 10–ª –∂–∏–¥–∫–æ—Å—Ç–∏
            let rateFor10L, rateUnit;
            if (objectData.unit.includes('–∫–≥')) {
                rateFor10L = (rate / liquidRate * 1000) * 10; // –≤ –≥—Ä–∞–º–º–∞—Ö
                rateUnit = '–≥/10 –ª';
            } else {
                rateFor10L = (rate / liquidRate * 1000) * 10; // –≤ –º–ª
                rateUnit = '–º–ª/10 –ª';
            }

            const formatRateValue = (value) => {
                if (!Number.isFinite(value)) return '‚Äî';
                return value % 1 === 0 ? value.toFixed(0) : value.toFixed(2);
            };

            const waitInterval = (objectData.preHarvestInterval ?? pesticideInfo.preHarvestInterval ?? '').toString().trim();
            const numberOfTreatments = (objectData.numberOfTreatments ?? pesticideInfo.numberOfTreatments ?? '').toString().trim();

            // –ü–æ–∏—Å–∫ –∞–Ω–∞–ª–æ–≥–æ–≤
            const currentIngredients = pesticideInfo.activeIngredients || {}; // –æ–±—ä–µ–∫—Ç { –≤–µ—â–µ—Å—Ç–≤–æ: –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è }

            const fullAnalogs = [];
            const partialAnalogs = [];

            const currentForm = normalizeFormValue(pesticideInfo.form);
            const currentIngredientKeys = Object.keys(currentIngredients).sort();

            for (const productName in pesticideData) {
                if (productName === pesticide) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º –ø—Ä–µ–ø–∞—Ä–∞—Ç
                const product = pesticideData[productName];
                const ingredients = product.activeIngredients || {};
                const productForm = normalizeFormValue(product.form);

                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –Ω–∞–±–æ—Ä—ã –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –≤–µ—â–µ—Å—Ç–≤
                const otherKeys = Object.keys(ingredients).sort();

                const sameIngredients = JSON.stringify(currentIngredientKeys) === JSON.stringify(otherKeys);
                const formsEquivalent = formsAreEquivalent(currentForm, productForm);

                if (sameIngredients) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏
                    let allSame = true;
                    for (const key of currentIngredientKeys) {
                        if (currentIngredients[key] !== ingredients[key]) {
                            allSame = false;
                            break;
                        }
                    }

                    if (formsEquivalent && allSame) {
                        fullAnalogs.push({ name: productName, url: product.url });
                    } else {
                        partialAnalogs.push({ name: productName, url: product.url });
                    }

                    continue;
                }
            }

            // –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
            const applicationFeatures = document.getElementById('applicationFeatures');
            const applicationLines = [
                `‚Ä¢ –ù–æ—Ä–º–∞ —Ä–∞—Å—Ö–æ–¥–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞: ${formatRateValue(rate)} –ª/–≥–∞`,
                `‚Ä¢ –†–∞—Å—Ö–æ–¥ —Ä–∞–±–æ—á–µ–π –∂–∏–¥–∫–æ—Å—Ç–∏: ${liquidRate.toFixed(0)} –ª/–≥–∞`
            ];

            applicationLines.push(`<strong>‚Ä¢ –ù–æ—Ä–º–∞ —Ä–∞—Å—Ö–æ–¥–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –Ω–∞ 10 –ª. –≤–æ–¥—ã: ${rateFor10L.toFixed(1)} ${rateUnit}</strong>`);

            applicationFeatures.innerHTML = `
                <strong>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:</strong><br>
                ${objectData.features || '‚Äî'}<br><br>
                ${applicationLines.join('<br>')}
            `;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            const additionalInfo = document.getElementById('additionalInfo');
            const packagingUnit = isKg ? '–∫–≥' : '–ª';
            const concentrationUnit = isKg ? '–≥/–∫–≥' : '–≥/–ª';
            const activeIngredientsData = pesticideInfo.activeIngredients || {};
            const ingredientsList = Object.entries(activeIngredientsData)
                .map(([name, conc]) => `${name} ${conc} ${concentrationUnit}`)
                .join(', ');
            const ingredientsText = ingredientsList || '‚Äî';
            const chemicalClass = pesticideInfo.chemicalClass || pesticideInfo.chemical–°lass || '‚Äî';
            const moALabel = getMoALabelByCategory(pesticideInfo.category || objectData.category || '');
            const moAFormatted = formatMoAValues(pesticideInfo.moA);
            const rawPackaging = pesticideInfo.packaging;
            const hasNumericPackaging = Number.isFinite(packagingVolume) && packagingVolume > 0;
            const packagingText = hasNumericPackaging
                ? `${packagingVolume} ${packagingUnit}`
                : (rawPackaging ? rawPackaging.toString() : '‚Äî');
            const pricePerPackageText = pricePerPackage !== null
                ? `${pricePerPackage.toFixed(2)} ‚ÇΩ${packagingText !== '‚Äî' ? ` –∑–∞ —É–ø–∞–∫–æ–≤–∫—É ${packagingText}` : ''}`
                : '–Ω/–¥';

            additionalInfo.innerHTML = `
                <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ:</strong><br>
                ‚Ä¢ –§–æ—Ä–º–∞: ${pesticideInfo.form}<br>
                ‚Ä¢ –î–µ–π—Å—Ç–≤—É—é—â–µ–µ –≤–µ—â–µ—Å—Ç–≤–æ: ${ingredientsText}<br>
                ‚Ä¢ –•–∏–º–∏—á–µ—Å–∫–∏–π –∫–ª–∞—Å—Å: ${chemicalClass}<br>
                ‚Ä¢ ${moALabel}: ${moAFormatted}<br>
                ‚Ä¢ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: ${pesticideInfo.manufactory}<br>
                ‚Ä¢ –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏: ${pesticideInfo.expirationDate} ${getYearWord(pesticideInfo.expirationDate)}<br>
                ‚Ä¢ –£–ø–∞–∫–æ–≤–∫–∞: ${packagingText}<br>
                ‚Ä¢ –¶–µ–Ω–∞ –∑–∞ —É–ø–∞–∫–æ–≤–∫—É: ${pricePerPackageText}
            `;

            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–Ω–∞–ª–æ–≥–∞—Ö
            let analogsHTML = '<strong>–ê–Ω–∞–ª–æ–≥–∏:</strong><br>';

            if (fullAnalogs.length > 0) {
                const analogLinks = fullAnalogs.map(analog =>
                    `<button type="button" class="analog-link" data-product="${encodeURIComponent(analog.name)}">${escapeHtml(analog.name)}</button>`
                ).join(', ');
                analogsHTML += `‚Ä¢ üü¢ –ü–æ–ª–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏: ${analogLinks}<br>`;
            } else {
                analogsHTML += '‚Ä¢ üü¢ –ü–æ–ª–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã<br>';
            }

            if (partialAnalogs.length > 0) {
                const analogLinks = partialAnalogs.map(analog =>
                    `<button type="button" class="analog-link" data-product="${encodeURIComponent(analog.name)}">${escapeHtml(analog.name)}</button>`
                ).join(', ');
                analogsHTML += `‚Ä¢ üü° –ß–∞—Å—Ç–∏—á–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏: ${analogLinks}<br>`;
            } else {
                analogsHTML += '‚Ä¢ üü° –ß–∞—Å—Ç–∏—á–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã<br>';
            }

            analogsInfo.innerHTML = analogsHTML;
            
            // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏
            buyButton.href = pesticideInfo.url;
            buyButton.style.display = 'block';
            
            resultsDiv.classList.add('show');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }
    
        // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setMode(currentMode);

        // –≤—ã–∑–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏
        loadJSON();
    </script>
</body>
</html>
